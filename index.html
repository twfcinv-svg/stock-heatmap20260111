<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‚¡ç¥¨ç†±åŠ›åœ–ï¼ˆå¯ä¸Šå‚³ / å¯åˆ†äº«ï¼‰</title>

  <!-- Plotly Treemap -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Excel parser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- URL-friendly compression -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif; }
    header { padding: 14px 16px; border-bottom: 1px solid var(--border); }
    h1 { margin: 0; font-size: 18px; }
    .muted { color: var(--muted); font-size: 13px; margin-top: 6px; line-height: 1.5; }
    .bar { display:flex; gap:10px; flex-wrap: wrap; padding: 12px 16px; border-bottom: 1px solid var(--border); align-items: center; }
    button { padding: 8px 10px; border: 1px solid var(--border); background: #fff; border-radius: 10px; cursor:pointer; }
    button:hover { background:#f9fafb; }
    input[type="file"] { padding: 6px 0; }
    input[type="text"], select {
      padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px;
      min-width: 220px; background:#fff;
    }
    #msg { padding: 0 16px 10px; color: #b91c1c; font-size: 13px; min-height: 18px; white-space: pre-wrap; }
    #chart { height: calc(100vh - 200px); }
    .ok { color: #047857 !important; }
    .drop {
      margin: 10px 16px 0;
      border: 2px dashed var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      color: var(--muted);
      font-size: 13px;
    }
    .pill { font-size:12px; padding:3px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); }
    .timebar { margin-top: 8px; display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
  </style>
</head>

<body>
  <header>
    <h1>è‚¡ç¥¨ç†±åŠ›åœ–ï¼ˆä¸Šå‚³è³‡æ–™ â†’ ç”¢ç”Ÿåˆ†äº«é€£çµï¼‰</h1>
    <div class="muted">
      é è¨­æœƒå˜—è©¦è®€å–åŒè³‡æ–™å¤¾çš„ <b>data.csv</b>ã€‚å¯æ‹–æ‹‰/é¸æª”ä¸Šå‚³ CSV/XLSX/JSONã€‚
      ã€Œç”¢ç”Ÿåˆ†äº«é€£çµã€æœƒæŠŠè³‡æ–™å£“ç¸®å¾Œæ”¾é€²ç¶²å€ <b>#hash</b>ï¼ˆé©åˆå°ä¸­å‹è³‡æ–™é›†ï¼‰ã€‚
      <span class="pill">æç¤ºï¼šå¤ªå¤šæª”ï¼ˆä¾‹å¦‚ä¸Šåƒæª”ï¼‰URL å¯èƒ½éé•·ï¼Œå»ºè­°æ”¹ç”¨ã€Œå¾ç¶²å€è¼‰å…¥ CSVã€</span>
      <div class="timebar">
        <span id="clockNow" class="pill">ç¾åœ¨æ™‚é–“ï¼š--</span>
        <span id="dataUpdated" class="pill">è³‡æ–™æ›´æ–°ï¼š--</span>
      </div>
    </div>
  </header>

  <div class="bar">
    <input id="file" type="file" accept=".csv,.xlsx,.xls,.json" />
    <button id="btnLoadDefault">è¼‰å…¥ï¼ˆæˆ–é‡è¼‰ï¼‰data.csv</button>

    <label class="muted" style="margin-left:4px;">æœŸé–“ï¼š</label>
    <select id="horizon">
      <option value="1d" selected>è¿‘1æ—¥</option>
      <option value="5d">è¿‘5æ—¥</option>
      <option value="20d">è¿‘20æ—¥</option>
      <option value="60d">è¿‘60æ—¥</option>
      <option value="1y">è¿‘ä¸€å¹´</option>
      <option value="ytd">YTD</option>
    </select>

    <label class="muted" style="margin-left:4px;">é¡¯ç¤ºæ¨¡å¼ï¼š</label>
    <select id="mode">
      <option value="none">å–®å±¤ï¼šé¡è‚¡ â†’ è‚¡ç¥¨</option>
      <option value="subcol">é›™å±¤ï¼šé¡è‚¡ â†’ å­åˆ†é¡æ¬„ä½ â†’ è‚¡ç¥¨</option>
      <option value="amountbin">é›™å±¤ï¼šé¡è‚¡ â†’ æˆäº¤é¡åˆ†ç´šï¼ˆå¤§/ä¸­/å°ï¼‰â†’ è‚¡ç¥¨</option>
    </select>

    <button id="btnShare">ç”¢ç”Ÿåˆ†äº«é€£çµ</button>
    <button id="btnCopy" disabled>è¤‡è£½åˆ†äº«é€£çµ</button>

    <span class="muted">æˆ–å¾ç¶²å€è¼‰å…¥ CSVï¼š</span>
    <input id="csvUrl" type="text" placeholder="è²¼ä¸Š data.csv çš„å…¬é–‹ç¶²å€ï¼ˆrawï¼‰" />
    <button id="btnLoadUrl">å¾ç¶²å€è¼‰å…¥</button>
  </div>

  <div class="drop">ğŸ“¥ ä½ ä¹Ÿå¯ä»¥æŠŠæª”æ¡ˆç›´æ¥æ‹–æ›³åˆ°é€™å€‹é é¢ä»»ä½•ä½ç½®æ”¾é–‹ï¼ˆCSV / XLSX / JSONï¼‰ã€‚</div>
  <div id="msg"></div>
  <div id="chart"></div>

<script>
  const $msg = document.getElementById('msg');
  const $file = document.getElementById('file');
  const $btnLoadDefault = document.getElementById('btnLoadDefault');
  const $btnShare = document.getElementById('btnShare');
  const $btnCopy = document.getElementById('btnCopy');
  const $csvUrl = document.getElementById('csvUrl');
  const $btnLoadUrl = document.getElementById('btnLoadUrl');
  const $mode = document.getElementById('mode');
  const $horizon = document.getElementById('horizon');

  let lastRawRows = null;  // åŸå§‹ rows
  let lastRows = null;     // normalized rows
  let lastMode = 'none';
  let lastHorizon = '1d';

  function setMsg(text, ok=false) {
    $msg.textContent = text || '';
    $msg.className = ok ? 'ok' : '';
  }

  window.addEventListener('error', (e) => setMsg('âš ï¸ JS éŒ¯èª¤ï¼š' + (e?.message || e), false));
  window.addEventListener('unhandledrejection', (e) => setMsg('âš ï¸ Promise éŒ¯èª¤ï¼š' + (e?.reason?.message || e?.reason || e), false));

  // ===== æ™‚é–“é¡¯ç¤º =====
  function startClockNow() {
    const el = document.getElementById('clockNow');
    if (!el) return;

    const fmt = new Intl.DateTimeFormat('zh-Hant-TW', {
      year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit',
      hour12:false,
      timeZone:'Asia/Taipei'
    });

    const tick = () => { el.textContent = `ç¾åœ¨æ™‚é–“ï¼š${fmt.format(new Date())}`; };
    tick();
    setInterval(tick, 1000);
  }

  async function showDataUpdatedAt() {
    const el = document.getElementById('dataUpdated');
    if (!el) return;

    // ä½ åŸæœ¬å¯«æ­»çš„ repo è³‡è¨Šï¼ˆéœ€è¦æ› repo è¨˜å¾—æ”¹ï¼‰
    const owner = "twfcinv-svg";
    const repo  = "stock-heatmap1229";
    const path  = "data.csv";

    try {
      const api = `https://api.github.com/repos/${owner}/${repo}/commits?path=${encodeURIComponent(path)}&per_page=1`;
      const res = await fetch(api, { headers: { 'Accept': 'application/vnd.github+json' }, cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const arr = await res.json();

      const iso = arr?.[0]?.commit?.committer?.date || arr?.[0]?.commit?.author?.date;
      if (!iso) throw new Error('æ‰¾ä¸åˆ° commit æ™‚é–“');

      const d = new Date(iso);
      el.textContent = `è³‡æ–™æ›´æ–°ï¼š${d.toLocaleString('zh-Hant-TW', { timeZone:'Asia/Taipei', hour12:false })}`;
    } catch (e) {
      el.textContent = `è³‡æ–™æ›´æ–°ï¼šè®€å–å¤±æ•—`;
    }
  }
  // ===================

  function horizonLabel(h) {
    const map = { '1d':'è¿‘1æ—¥', '5d':'è¿‘5æ—¥', '20d':'è¿‘20æ—¥', '60d':'è¿‘60æ—¥', '1y':'è¿‘ä¸€å¹´', 'ytd':'YTD' };
    return map[h] || h;
  }

  function toNumber(x) {
    if (x === null || x === undefined) return NaN;
    if (typeof x === 'number') return x;
    const s = String(x)
      .trim()
      .replace(/,/g,'')
      .replace(/ï¼…/g,'%')
      .replace(/%/g,'');
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  // â˜…é¡¯ç¤ºåœ¨ symbol åº•ä¸‹çš„æ¼²è·Œå¹…æ ¼å¼ï¼ˆ1 ä½å°æ•¸ï¼‰
  function fmtPct(x, digits=1) {
    const n = Number(x);
    if (!Number.isFinite(n)) return '';
    const sign = n > 0 ? '+' : '';
    return `${sign}${n.toFixed(digits)}%`;
  }

  function pickColumn(headers, candidates) {
    const lower = headers.map(h => String(h).trim().toLowerCase());
    for (const c of candidates) {
      const idx = lower.indexOf(String(c).toLowerCase());
      if (idx >= 0) return headers[idx];
    }
    return null;
  }

  function quantiles(values) {
    const xs = values.filter(Number.isFinite).slice().sort((a,b)=>a-b);
    if (xs.length === 0) return {q1:0, q2:0};
    const q = (p) => {
      const idx = (xs.length - 1) * p;
      const lo = Math.floor(idx), hi = Math.ceil(idx);
      if (lo === hi) return xs[lo];
      const t = idx - lo;
      return xs[lo] * (1 - t) + xs[hi] * t;
    };
    return {q1: q(0.33), q2: q(0.66)};
  }

  function amountBucket(v, q1, q2) {
    if (!Number.isFinite(v)) return 'æœªçŸ¥';
    if (v >= q2) return 'å¤§';
    if (v >= q1) return 'ä¸­';
    return 'å°';
  }

  // â˜…é¡è‰²ï¼ˆå ±é…¬ï¼‰æ¬„ä½å€™é¸ï¼šä¾æœŸé–“
  function changeCandidatesByHorizon(h) {
    const common = ['change','chg','return','pct','perf','æ¼²è·Œ','æ¼²è·Œå¹…','å ±é…¬','å ±é…¬ç‡','è®Šå‹•'];
    const map = {
      '1d':  ['chg_1d','change_1d','ret_1d','r1d','1d','è¿‘1æ—¥','1æ—¥','ä¸€æ—¥', ...common],
      '5d':  ['chg_5d','change_5d','ret_5d','r5d','5d','è¿‘5æ—¥','5æ—¥','äº”æ—¥', ...common],
      '20d': ['chg_20d','change_20d','ret_20d','r20d','20d','è¿‘20æ—¥','20æ—¥','äºŒåæ—¥','æœˆ', ...common],
      '60d': ['chg_60d','change_60d','ret_60d','r60d','60d','è¿‘60æ—¥','60æ—¥','ä¸‰æœˆ', ...common],
      '1y':  ['chg_1y','change_1y','ret_1y','r1y','1y','1yr','è¿‘ä¸€å¹´','1å¹´','ä¸€å¹´', ...common],
      'ytd': ['ytd','chg_ytd','change_ytd','ret_ytd','ä»Šå¹´ä»¥ä¾†','å¹´åˆè‡³ä»Š', ...common]
    };
    return map[h] || map['1d'];
  }

  // â˜…é¢ç©ï¼ˆé‡ï¼‰æ¬„ä½å€™é¸ï¼šä¾æœŸé–“
  function valueCandidatesByHorizon(h) {
    const map = {
      '1d':  ['amt_1d','amount_1d','turnover_1d','value_1d','vol_1d','è¿‘1æ—¥æˆäº¤é¡','1æ—¥æˆäº¤é¡','1æ—¥å‡é‡'],
      '5d':  ['amt_5d','amount_5d','turnover_5d','value_5d','vol_5d','è¿‘5æ—¥æˆäº¤é¡','5æ—¥æˆäº¤é¡','5æ—¥å‡é‡'],
      '20d': ['amt_20d','amount_20d','turnover_20d','value_20d','vol_20d','è¿‘20æ—¥æˆäº¤é¡','20æ—¥æˆäº¤é¡','20æ—¥å‡é‡'],
      '60d': ['amt_60d','amount_60d','turnover_60d','value_60d','vol_60d','è¿‘60æ—¥æˆäº¤é¡','60æ—¥æˆäº¤é¡','60æ—¥å‡é‡'],
      '1y':  ['amt_1y','amount_1y','turnover_1y','value_1y','vol_1y','è¿‘ä¸€å¹´æˆäº¤é¡','1å¹´æˆäº¤é¡','ä¸€å¹´æˆäº¤é¡'],
      'ytd': ['amt_ytd','amount_ytd','turnover_ytd','value_ytd','vol_ytd','ytd_amount','ä»Šå¹´ä»¥ä¾†æˆäº¤é¡','å¹´åˆè‡³ä»Šæˆäº¤é¡']
    };
    return map[h] || map['1d'];
  }

function normalizeRows(rawRows, mode, horizon) {
  if (!Array.isArray(rawRows) || rawRows.length === 0) throw new Error('æ²’æœ‰è®€åˆ°ä»»ä½•è³‡æ–™åˆ—ã€‚');

  const headers = Object.keys(rawRows[0] || {});
  if (headers.length === 0) throw new Error('æ‰¾ä¸åˆ°æ¬„ä½ï¼ˆheaderï¼‰ã€‚');

  const colGroup  = pickColumn(headers, ['group','sector','industry','åˆ†é¡','ç”¢æ¥­','é¡åˆ¥','é¡è‚¡']);
  const colSub    = pickColumn(headers, ['sub','subgroup','sub_group','subsector','sub_sector','å­åˆ†é¡','å­ç”¢æ¥­','æ¬¡åˆ†é¡','æ¬¡ç”¢æ¥­','ç´°åˆ†','ç´°é …']);
  const colSymbol = pickColumn(headers, ['symbol','name','åç¨±','è‚¡ç¥¨']); // é¡¯ç¤ºç”¨

  // â˜…æ–°å¢ï¼šå°ˆé–€æ‹¿ä¾†çµ„ç¶²å€çš„è‚¡ç¥¨ä»£ç¢¼æ¬„ä½ï¼ˆå„ªå…ˆ stock_code/è‚¡ç¥¨ä»£ç¢¼ï¼‰
  const colCode   = pickColumn(headers, ['stock_code','stockcode','stockCode','è‚¡ç¥¨ä»£ç¢¼','è­‰åˆ¸ä»£ç¢¼','ä»£ç¢¼','code','ticker']);

  // â˜…ä¾æœŸé–“æŒ‘ã€Œé‡ã€ç•¶é¢ç©ï¼ˆå¿…è¦ï¼‰
  const colValue  = pickColumn(headers, valueCandidatesByHorizon(horizon));
  if (!colValue) {
    throw new Error(
      `æ‰¾ä¸åˆ°ã€Œ${horizonLabel(horizon)}ã€å°æ‡‰çš„é‡(é¢ç©)æ¬„ä½ã€‚\n` +
      `è«‹æä¾›å…¶ä¸­ä¸€å€‹æ¬„ä½ï¼š\n${valueCandidatesByHorizon(horizon).join(' / ')}`
    );
  }

  // â˜…ä¾æœŸé–“æŒ‘ã€Œå ±é…¬ã€ç•¶é¡è‰²ï¼ˆå¿…è¦ï¼‰
  const colChange = pickColumn(headers, changeCandidatesByHorizon(horizon));
  if (!colChange) {
    throw new Error(
      `æ‰¾ä¸åˆ°ã€Œ${horizonLabel(horizon)}ã€å°æ‡‰çš„è®Šå‹•(é¡è‰²)æ¬„ä½ã€‚\n` +
      `è«‹æä¾›å…¶ä¸­ä¸€å€‹æ¬„ä½ï¼š\n${changeCandidatesByHorizon(horizon).join(' / ')}`
    );
  }

  if (!colSymbol) throw new Error('æ‰¾ä¸åˆ°ã€Œsymbolã€é¡¯ç¤ºæ¬„ä½ï¼ˆå¯æ¥å—ï¼šsymbol/name/åç¨±/è‚¡ç¥¨ï¼‰ã€‚');
  if (!colCode) throw new Error('æ‰¾ä¸åˆ°ã€Œstock_codeã€è‚¡ç¥¨ä»£ç¢¼æ¬„ä½ï¼ˆå»ºè­°æ¬„ä½åï¼šstock_code æˆ– è‚¡ç¥¨ä»£ç¢¼ï¼‰ã€‚');

  // å…ˆè½‰æˆåŸºæœ¬çµæ§‹ï¼ˆsub å¾ŒçºŒä¾ mode æ±ºå®šï¼‰
  let rows = rawRows.map((r) => {
    const group  = colGroup ? String(r[colGroup] ?? 'æœªåˆ†é¡').trim() : 'æœªåˆ†é¡';
    const symbol = String(r[colSymbol] ?? '').trim();
    const code   = String(r[colCode] ?? '').trim(); // â˜…ç¶²å€ç”¨ä»£ç¢¼
    const value  = toNumber(r[colValue]);
    const change = toNumber(r[colChange]);

    if (!symbol) return null;
    if (!code) return null;

    return {
      group,
      sub: '',
      symbol,
      code, // â˜…æ–°å¢
      value: Number.isFinite(value) && value > 0 ? value : 1,
      change: Number.isFinite(change) ? change : 0
    };
  }).filter(Boolean);

  if (rows.length === 0) throw new Error('è³‡æ–™åˆ—è§£æå¾Œç‚ºç©ºï¼ˆå¯èƒ½ symbol/stock_code æ¬„ä½æœ‰ç©ºå€¼ï¼‰ã€‚');

  if (mode === 'subcol') {
    if (!colSub) throw new Error('ä½ é¸äº†ã€Œå­åˆ†é¡æ¬„ä½ã€æ¨¡å¼ï¼Œä½†è³‡æ–™æ‰¾ä¸åˆ°å­åˆ†é¡æ¬„ä½ï¼ˆsub/å­åˆ†é¡/æ¬¡åˆ†é¡â€¦ï¼‰ã€‚');

    rows = rawRows.map((r) => {
      const group  = colGroup ? String(r[colGroup] ?? 'æœªåˆ†é¡').trim() : 'æœªåˆ†é¡';
      const symbol = String(r[colSymbol] ?? '').trim();
      const code   = String(r[colCode] ?? '').trim();
      const value  = toNumber(r[colValue]);
      const change = toNumber(r[colChange]);
      const sub    = String(r[colSub] ?? 'æœªåˆ†é¡').trim() || 'æœªåˆ†é¡';

      if (!symbol) return null;
      if (!code) return null;

      return {
        group,
        sub,
        symbol,
        code, // â˜…æ–°å¢
        value: Number.isFinite(value) && value > 0 ? value : 1,
        change: Number.isFinite(change) ? change : 0
      };
    }).filter(Boolean);

    if (rows.length === 0) throw new Error('è³‡æ–™åˆ—è§£æå¾Œç‚ºç©ºï¼ˆå¯èƒ½ symbol/stock_code æ¬„ä½æœ‰ç©ºå€¼ï¼‰ã€‚');
    return rows;
  }

  if (mode === 'amountbin') {
    const byGroup = new Map();
    for (const r of rows) {
      if (!byGroup.has(r.group)) byGroup.set(r.group, []);
      byGroup.get(r.group).push(r.value);
    }
    const qMap = new Map();
    for (const [g, vs] of byGroup.entries()) qMap.set(g, quantiles(vs));
    rows = rows.map(r => {
      const {q1, q2} = qMap.get(r.group) || {q1:0,q2:0};
      return {...r, sub: `æˆäº¤é¡${amountBucket(r.value, q1, q2)}`};
    });
    return rows;
  }

  return rows;
}


 function buildTreemap(rows, mode) {
  const ids = [], labels = [], parents = [], values = [], colors = [], customdata = [];
  const ROOT_ID = 'root';

  ids.push(ROOT_ID);
  labels.push('å…¨éƒ¨');
  parents.push('');
  values.push(0);
  colors.push(0);
  customdata.push(null);

  const groupAgg = new Map();
  const subAgg = new Map();

  for (const r of rows) {
    if (!groupAgg.has(r.group)) groupAgg.set(r.group, {value:0, wchg:0});
    const g = groupAgg.get(r.group);
    g.value += r.value;
    g.wchg += r.change * r.value;

    if (mode !== 'none') {
      const key = `${r.group}||${r.sub || 'æœªåˆ†é¡'}`;
      if (!subAgg.has(key)) subAgg.set(key, {value:0, wchg:0, group:r.group, sub:(r.sub || 'æœªåˆ†é¡')});
      const s = subAgg.get(key);
      s.value += r.value;
      s.wchg += r.change * r.value;
    }
  }

  for (const [gname, g] of groupAgg.entries()) {
    const gid = `g|${gname}`;
    ids.push(gid);
    labels.push(gname);
    parents.push(ROOT_ID);
    values.push(g.value);
    colors.push(g.value ? (g.wchg / g.value) : 0);
    customdata.push(null);
  }

  if (mode !== 'none') {
    for (const s of subAgg.values()) {
      const sid = `s|${s.group}|${s.sub}`;
      ids.push(sid);
      labels.push(s.sub);
      parents.push(`g|${s.group}`);
      values.push(s.value);
      colors.push(s.value ? (s.wchg / s.value) : 0);
      customdata.push(null);
    }
  }

  for (const r of rows) {
    const parentId = (mode === 'none')
      ? `g|${r.group}`
      : `s|${r.group}|${r.sub || 'æœªåˆ†é¡'}`;

    const lid = `l|${r.group}|${r.sub || ''}|${r.symbol}`;
    ids.push(lid);

    // è‘‰ç¯€é» label = symbol + æ›è¡Œ + æ¼²è·Œå¹…ï¼ˆ1ä½å°æ•¸ï¼‰
    labels.push(`${r.symbol}<br>${fmtPct(r.change)}`);

    parents.push(parentId);
    values.push(r.value);
    colors.push(r.change);

    // â˜…æŠŠè‚¡ç¥¨ä»£ç¢¼å¡é€² customdataï¼ˆä¹‹å¾Œé»æ“Šæœƒç”¨åˆ°ï¼‰
    customdata.push(r.code || '');
  }

  values[0] = Array.from(groupAgg.values()).reduce((s,x)=>s+x.value,0);
  return {ids, labels, parents, values, colors, customdata};
}

  function render(rawRows) {
    const mode = $mode.value;
    const horizon = $horizon.value;

    lastMode = mode;
    lastHorizon = horizon;

    const rows = normalizeRows(rawRows, mode, horizon);
    lastRows = rows;

    const {ids, labels, parents, values, colors, customdata} = buildTreemap(rows, mode);

const data = [{
  type: 'treemap',
  ids,
  labels,
  parents,
  values,
  customdata, // â˜…åŠ é€™è¡Œ
  branchvalues: 'total',
  textinfo: 'label',
  marker: {
    colors,
    colorscale: [
      [0,'#1a9641'],
      [0.5,'#f3f4f6'],
      [1,'#d7191c']
    ],
    cmid: 0,
    line: { width: 1, color: '#d1d5db' }
  },
  hovertemplate:
    `<b>%{label}</b><br>` +
    `ä¸Šå±¤ï¼š%{parent}<br>` +
    `é‡ï¼ˆ${horizonLabel(horizon)}ï¼‰ï¼š%{value}<br>` +
    `è®Šå‹•ï¼ˆ${horizonLabel(horizon)}ï¼‰ï¼š%{color:.2f}<extra></extra>`
}];

Plotly.newPlot('chart', data, {margin:{l:10,r:10,t:30,b:10}}, {responsive:true, displaylogo:false})
  .then(() => {
    const chartDiv = document.getElementById('chart');
    if (!chartDiv) return;

    // é¿å…é‡è¤‡ç¶å®šï¼ˆæ¯æ¬¡ render éƒ½æœƒ newPlotï¼‰
    if (typeof chartDiv.removeAllListeners === 'function') {
      chartDiv.removeAllListeners('plotly_treemapclick');
    }

    chartDiv.on('plotly_treemapclick', (e) => {
      const pt = e?.points?.[0];
      const id = String(pt?.id || '');

      // â˜…åªæœ‰è‘‰ç¯€é»ï¼ˆè‚¡ç¥¨ï¼‰æ‰è™•ç†ï¼›é˜»æ­¢ zoom
      if (!id.startsWith('l|')) return;

      const code = String(pt?.customdata || '').trim();
      if (!code) {
        setMsg('æ‰¾ä¸åˆ°è‚¡ç¥¨ä»£ç¢¼ï¼ˆè«‹ç¢ºèª CSV æœ‰ stock_code æ¬„ä½ä¸”ä¸ç‚ºç©ºï¼‰ã€‚', false);
        return false;
      }

      const url = `https://www.fbs.com.tw/MKT/Index?name=%EF%BC%AB%E7%B7%9A%E5%9C%96&stock=${encodeURIComponent(code)}`;
      window.open(url, '_blank', 'noopener,noreferrer');

      return false; // â˜…é˜»æ­¢ Plotly é è¨­ zoomï¼ˆé¿å…é»åˆ°åº•å±¤è®Šç©ºç™½ï¼‰
    });
  });

setMsg(`å·²æ›´æ–°ç†±åŠ›åœ–ï¼ˆæœŸé–“ï¼š${horizonLabel(horizon)}ï¼›æ¨¡å¼ï¼š${mode}ï¼‰ã€‚`, true);
$btnCopy.disabled = true;

showDataUpdatedAt();
  }

  function loadCSVText(text) {
    const parsed = Papa.parse(text, {header: true, skipEmptyLines: true});
    if (parsed.errors && parsed.errors.length) {
      throw new Error('CSV è§£æéŒ¯èª¤ï¼š' + parsed.errors[0].message);
    }
    return parsed.data;
  }

  async function handleFile(file) {
    setMsg('');
    const name = (file.name || '').toLowerCase();
    const buf = await file.arrayBuffer();

    if (name.endsWith('.csv')) {
      const text = new TextDecoder('utf-8').decode(buf);
      lastRawRows = loadCSVText(text);
      render(lastRawRows);
      return;
    }
    if (name.endsWith('.json')) {
      const text = new TextDecoder('utf-8').decode(buf);
      const raw = JSON.parse(text);
      lastRawRows = Array.isArray(raw) ? raw : (raw.rows || raw.data || []);
      render(lastRawRows);
      return;
    }
    if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
      const wb = XLSX.read(buf, {type: 'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      lastRawRows = XLSX.utils.sheet_to_json(sheet, {defval: ''});
      render(lastRawRows);
      return;
    }
    throw new Error('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ã€‚è«‹ç”¨ CSV / XLSX / JSONã€‚');
  }

  function makeShareLink(mode, horizon, rawRows) {
    const payload = {v: 5, mode, horizon, rawRows};
    const json = JSON.stringify(payload);
    const compressed = LZString.compressToEncodedURIComponent(json);
    return `${location.origin}${location.pathname}#data=${compressed}`;
  }

  function tryLoadFromHash() {
    const hash = location.hash || '';
    if (!hash.startsWith('#data=')) return false;
    try {
      const encoded = hash.slice(6);
      const json = LZString.decompressFromEncodedURIComponent(encoded);
      const payload = JSON.parse(json);

      if (payload?.mode) $mode.value = payload.mode;
      if (payload?.horizon) $horizon.value = payload.horizon;

      if (payload?.rawRows && Array.isArray(payload.rawRows)) {
        lastRawRows = payload.rawRows;
        render(lastRawRows);
        setMsg('å·²å¾åˆ†äº«é€£çµè¼‰å…¥è³‡æ–™ã€‚', true);
        return true;
      }
      if (payload?.rows && Array.isArray(payload.rows)) {
        lastRawRows = payload.rows;
        render(lastRawRows);
        setMsg('å·²å¾åˆ†äº«é€£çµè¼‰å…¥è³‡æ–™ï¼ˆèˆŠæ ¼å¼ç›¸å®¹ï¼‰ã€‚', true);
        return true;
      }

      throw new Error('hash å…§å®¹ä¸æ­£ç¢º');
    } catch (e) {
      setMsg('åˆ†äº«é€£çµè§£æå¤±æ•—ï¼š' + (e?.message || e));
      return false;
    }
  }

  async function loadFromUrl(url) {
    setMsg('');
    if (!url) throw new Error('è«‹è²¼ä¸Š CSV çš„å…¬é–‹ç¶²å€ã€‚');
    const res = await fetch(url, {cache: 'no-store'});
    if (!res.ok) throw new Error(`æŠ“å–å¤±æ•—ï¼šHTTP ${res.status}`);
    const text = await res.text();
    lastRawRows = loadCSVText(text);
    render(lastRawRows);
  }

  async function loadDefaultCSV() {
    try {
      const res = await fetch('./data.csv', {cache: 'no-store'});
      if (!res.ok) throw new Error(`æŠ“å– data.csv å¤±æ•—ï¼šHTTP ${res.status}`);
      const text = await res.text();
      lastRawRows = loadCSVText(text);
      render(lastRawRows);
      setMsg('å·²è¼‰å…¥ data.csvã€‚', true);
    } catch (e) {
      setMsg('è¼‰å…¥ data.csv å¤±æ•—ï¼ˆæœ¬æ©Ÿ file:// å¸¸è¦‹é™åˆ¶ï¼Œéƒ¨ç½²åˆ° Pages å°±æ­£å¸¸ï¼‰ï¼š' + (e?.message || e));
    }
  }

  // events
  $file.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    try { await handleFile(f); }
    catch (err) { setMsg(err?.message || String(err)); }
  });

  window.addEventListener('dragover', (e) => { e.preventDefault(); });
  window.addEventListener('drop', async (e) => {
    e.preventDefault();
    const f = e.dataTransfer?.files?.[0];
    if (!f) return;
    try { await handleFile(f); }
    catch (err) { setMsg(err?.message || String(err)); }
  });

  $btnLoadDefault.addEventListener('click', loadDefaultCSV);

  $mode.addEventListener('change', () => {
    try {
      if (!lastRawRows) { setMsg('å·²åˆ‡æ›é¡¯ç¤ºæ¨¡å¼ã€‚è«‹å…ˆè¼‰å…¥ data.csv æˆ–ä¸Šå‚³æª”æ¡ˆã€‚', true); return; }
      render(lastRawRows);
    } catch (e) {
      setMsg(e?.message || String(e));
    }
  });

  $horizon.addEventListener('change', () => {
    try {
      if (!lastRawRows) { setMsg('å·²åˆ‡æ›æœŸé–“ã€‚è«‹å…ˆè¼‰å…¥ data.csv æˆ–ä¸Šå‚³æª”æ¡ˆã€‚', true); return; }
      render(lastRawRows);
    } catch (e) {
      setMsg(e?.message || String(e));
    }
  });

  $btnShare.addEventListener('click', () => {
    try {
      if (!lastRawRows) throw new Error('è«‹å…ˆä¸Šå‚³è³‡æ–™æˆ–æˆåŠŸè¼‰å…¥ data.csvã€‚');
      const url = makeShareLink($mode.value, $horizon.value, lastRawRows);
      location.hash = url.split('#')[1];
      setMsg('å·²ç”¢ç”Ÿåˆ†äº«é€£çµï¼ˆè³‡æ–™å·²å¯«å…¥ç¶²å€ #hashï¼‰ã€‚å¯æŒ‰ã€Œè¤‡è£½åˆ†äº«é€£çµã€ã€‚', true);
      $btnCopy.disabled = false;
    } catch (err) {
      setMsg(err?.message || String(err));
    }
  });

  $btnCopy.addEventListener('click', async () => {
    try {
      const url = `${location.origin}${location.pathname}${location.hash}`;
      await navigator.clipboard.writeText(url);
      setMsg('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚', true);
    } catch (err) {
      setMsg('è¤‡è£½å¤±æ•—ï¼šä½ å¯ä»¥ç›´æ¥æ‰‹å‹•è¤‡è£½ç¶²å€åˆ—ã€‚');
    }
  });

  $btnLoadUrl.addEventListener('click', async () => {
    try { await loadFromUrl($csvUrl.value.trim()); }
    catch (err) { setMsg(err?.message || String(err)); }
  });

  // boot
  startClockNow();
  showDataUpdatedAt();

  if (!tryLoadFromHash()) {
    loadDefaultCSV();
  }
</script>
</body>
</html>

